# PandaFactor å¿«é€Ÿå¼€å§‹æŒ‡å—

## æ¦‚è¿°

PandaFactoræ˜¯ä¸€ä¸ªä¸“ä¸šçš„é‡åŒ–å› å­è®¡ç®—å’Œåˆ†æç³»ç»Ÿï¼Œæœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨åœ¨10åˆ†é’Ÿå†…å¿«é€Ÿæ­å»ºç¯å¢ƒå¹¶è¿è¡Œç¬¬ä¸€ä¸ªå› å­åˆ†æã€‚

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

### å‰ç½®è¦æ±‚

- Python 3.8+
- MongoDB 4.4+
- Git

### ä¸€é”®å¯åŠ¨

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/meaigood001/panda_factor.git
cd panda_factor

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. é…ç½®æ•°æ®åº“
# ç¼–è¾‘ panda_common/panda_common/config.yaml
# ç¡®ä¿MongoDBè¿æ¥ä¿¡æ¯æ­£ç¡®

# 4. å¯åŠ¨æœåŠ¡
python -m panda_factor_server

# 5. è®¿é—®Webç•Œé¢
# æµè§ˆå™¨æ‰“å¼€: http://localhost:8111/factor
```

## ğŸ“‹ ç¯å¢ƒå‡†å¤‡

### 1. ç³»ç»Ÿè¦æ±‚

| ç»„ä»¶ | æœ€ä½ç‰ˆæœ¬ | æ¨èç‰ˆæœ¬ |
|------|----------|----------|
| Python | 3.8 | 3.9+ |
| MongoDB | 4.4 | 5.0+ |
| å†…å­˜ | 4GB | 8GB+ |
| ç£ç›˜ | 10GB | 50GB+ |

### 2. å®‰è£…MongoDB

#### Windows
```bash
# ä¸‹è½½å¹¶å®‰è£…MongoDB Community Server
# https://www.mongodb.com/try/download/community

# å¯åŠ¨MongoDBæœåŠ¡
net start MongoDB
```

#### macOS
```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew tap mongodb/brew
brew install mongodb-community

# å¯åŠ¨æœåŠ¡
brew services start mongodb/brew
```

#### Linux (Ubuntu)
```bash
# å¯¼å…¥å…¬é’¥
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -

# æ·»åŠ ä»“åº“
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list

# å®‰è£…
sudo apt-get update
sudo apt-get install -y mongodb-org

# å¯åŠ¨æœåŠ¡
sudo systemctl start mongod
```

### 3. é¡¹ç›®å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/meaigood001/panda_factor.git
cd panda_factor

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python -m venv venv
source venv/bin/activate  # Linux/macOS
# æˆ–
venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¼€å‘æ¨¡å¼å®‰è£…å„æ¨¡å—
cd panda_common && pip install -e ..
cd ../panda_data && pip install -e ..
cd ../panda_factor && pip install -e ..
cd ../panda_factor_server && pip install -e ..
```

## âš™ï¸ é…ç½®è®¾ç½®

### 1. æ•°æ®åº“é…ç½®

ç¼–è¾‘ `panda_common/panda_common/config.yaml`ï¼š

```yaml
# æ•°æ®åº“é…ç½®
MONGO_USER: "panda"
MONGO_PASSWORD: "panda"
MONGO_URI: "127.0.0.1:27017"
MONGO_AUTH_DB: "admin"
MONGO_DB: "panda"

# æ•°æ®æºé…ç½®ï¼ˆé€‰æ‹©ä¸€ä¸ªï¼‰
DATASOURCE: tqsdk  # æˆ– ricequant, xtquant
DATAHUBSOURCE: "tushare"  # æˆ– ricequant

# Tushareé…ç½®ï¼ˆå¦‚æœä½¿ç”¨Tushareï¼‰
TS_TOKEN: "your_tushare_token"

# RiceQuanté…ç½®ï¼ˆå¦‚æœä½¿ç”¨RiceQuantï¼‰
MUSER: "your_ricequant_username"
MPASSWORD: "your_ricequant_password"
```

### 2. æ•°æ®æºé…ç½®

#### Tushareï¼ˆæ¨èæ–°æ‰‹ï¼‰
1. æ³¨å†ŒTushareè´¦å·ï¼šhttps://tushare.pro/
2. è·å–API Token
3. åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `TS_TOKEN`

#### RiceQuant
1. æ³¨å†ŒRiceQuantè´¦å·ï¼šhttps://www.ricequant.com/
2. è·å–ç”¨æˆ·åå’Œå¯†ç 
3. åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `MUSER` å’Œ `MPASSWORD`

### 3. éªŒè¯é…ç½®

```python
# æµ‹è¯•æ•°æ®åº“è¿æ¥
from panda_common.config import config
from panda_common.handlers.database_handler import DatabaseHandler

try:
    db_handler = DatabaseHandler(config)
    print("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
except Exception as e:
    print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")

# æµ‹è¯•æ•°æ®æº
import panda_data
panda_data.init()
print("âœ… æ•°æ®æºåˆå§‹åŒ–æˆåŠŸ")
```

## ğŸ¯ å¿«é€Ÿä½“éªŒ

### æ–¹å¼1ï¼šWebç•Œé¢ä½“éªŒï¼ˆæ¨èæ–°æ‰‹ï¼‰

1. **å¯åŠ¨WebæœåŠ¡**
```bash
python -m panda_factor_server
```

2. **è®¿é—®ç•Œé¢**
- æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8111/factor
- åœ¨Webç•Œé¢ä¸­åˆ›å»ºå’Œæµ‹è¯•å› å­

3. **åˆ›å»ºç¬¬ä¸€ä¸ªå› å­**
- é€‰æ‹©"æ–°å»ºå› å­"
- è¾“å…¥å› å­åç§°ï¼š`my_first_factor`
- é€‰æ‹©å› å­ç±»å‹ï¼š`å…¬å¼æ¨¡å¼`
- è¾“å…¥å› å­å…¬å¼ï¼š`CLOSE/DELAY(CLOSE,5)-1`
- è®¾ç½®å‚æ•°å¹¶è¿è¡Œåˆ†æ

### æ–¹å¼2ï¼šä»£ç ä½“éªŒï¼ˆé€‚åˆå¼€å‘è€…ï¼‰

1. **åˆ›å»ºç®€å•å› å­**
```python
# create_simple_factor.py
from panda_factor.generate.factor_base import Factor

class SimpleFactor(Factor):
    def calculate(self, factors):
        close = factors['close']
        # è®¡ç®—5æ—¥æ”¶ç›Šç‡å› å­
        result = close / self.DELAY(close, 5) - 1
        return result

# æ³¨å†Œå› å­
from panda_factor.generate.factor_loader import register_factor
register_factor('simple_return', SimpleFactor)
```

2. **è¿è¡Œå› å­åˆ†æ**
```python
# run_analysis.py
import panda_data
from panda_factor.analysis.factor_analysis import factor_analysis
from panda_common.models.factor_analysis_params import Params
from panda_common.handlers.log_handler import get_factor_logger

# åˆå§‹åŒ–
panda_data.init()

# è®¾ç½®å‚æ•°
params = Params()
params.start_date = "2024-01-01"
params.end_date = "2024-03-31"
params.adjustment_cycle = 5
params.group_number = 10
params.factor_direction = 1

# è·å–å› å­æ•°æ®
factor_data = panda_data.get_factor_by_name(
    factor_name="simple_return",
    start_date="20240101",
    end_date="20240331"
)

# è¿è¡Œåˆ†æ
logger = get_factor_logger("simple_factor")
factor_analysis(factor_data, params, "simple_factor", "task_001", logger)

print("âœ… å› å­åˆ†æå®Œæˆï¼")
```

## ğŸ“Š å¸¸ç”¨å› å­ç¤ºä¾‹

### 1. æŠ€æœ¯æŒ‡æ ‡å› å­

```python
# åŠ¨é‡å› å­
momentum = "CLOSE/DELAY(CLOSE,20) - 1"

# æ³¢åŠ¨ç‡å› å­
volatility = "STDDEV(RETURNS,20)"

# åè½¬å› å­
reversal = "-(CLOSE/DELAY(CLOSE,5) - 1)"

# æˆäº¤é‡å› å­
volume_factor = "RANK(VOLUME)"

# ä»·æ ¼å› å­
price_factor = "RANK(CLOSE)"
```

### 2. åŸºæœ¬é¢å› å­

```python
# å¸‚ç›ˆç‡å› å­
pe_factor = "-1/PE"

# å¸‚å‡€ç‡å› å­
pb_factor = "-1/PB"

# å¸‚é”€ç‡å› å­
ps_factor = "-1/PS"

# æ¢æ‰‹ç‡å› å­
turnover_factor = "TURNOVER"
```

### 3. Pythonç±»å› å­

```python
class CustomMomentumFactor(Factor):
    def calculate(self, factors):
        close = factors['close']
        volume = factors['volume']
        
        # è®¡ç®—æˆäº¤é‡åŠ æƒçš„åŠ¨é‡
        momentum = close / self.DELAY(close, 20) - 1
        weighted_momentum = momentum * self.RANK(volume)
        
        return self.RANK(weighted_momentum)

# æ³¨å†Œå› å­
from panda_factor.generate.factor_loader import register_factor
register_factor('volume_weighted_momentum', CustomMomentumFactor)
```

## ğŸ”§ å¸¸ç”¨æ“ä½œ

### 1. æ•°æ®æ›´æ–°

```bash
# å¯åŠ¨æ•°æ®æ›´æ–°æœåŠ¡
python -m panda_data_hub

# æŸ¥çœ‹æ›´æ–°æ—¥å¿—
tail -f logs/data_cleaner.log
```

### 2. å› å­ç®¡ç†

```python
# æŸ¥çœ‹æ‰€æœ‰å› å­
from panda_data import factor_reader
factors = factor_reader.get_all_factors()
print(f"å¯ç”¨å› å­: {factors}")

# è·å–ç‰¹å®šå› å­æ•°æ®
factor_data = panda_data.get_factor_by_name(
    factor_name="momentum",
    start_date="20240101",
    end_date="20240331"
)
```

### 3. åˆ†æç»“æœæŸ¥è¯¢

```python
from panda_common.handlers.database_handler import DatabaseHandler
from panda_common.config import config

db_handler = DatabaseHandler(config)

# æŸ¥è¯¢åˆ†æç»“æœ
results = db_handler.mongo_find(
    "panda",
    "factor_analysis_results",
    {"factor_name": "momentum"}
)

for result in results:
    print(f"å› å­: {result['factor_name']}")
    print(f"ICå‡å€¼: {result['factor_data_analysis'][0]['IC_mean']}")
    print(f"å¹´åŒ–æ”¶ç›Š: {result['group_return_analysis'][0]['å¹´åŒ–æ”¶ç›Šç‡']}")
```

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. VSCodeé…ç½®

åˆ›å»º `.vscode/settings.json`ï¼š

```json
{
    "python.defaultInterpreterPath": "./venv/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "python.testing.pytestEnabled": true,
    "python.testing.pytestArgs": ["tests/"]
}
```

### 2. IDEé…ç½®ï¼ˆPyCharmï¼‰

1. æ‰“å¼€é¡¹ç›®
2. è®¾ç½®Pythonè§£é‡Šå™¨ä¸ºè™šæ‹Ÿç¯å¢ƒ
3. å°†ä»¥ä¸‹ç›®å½•æ ‡è®°ä¸ºSources Rootï¼š
   - `panda_common`
   - `panda_data`
   - `panda_factor`
   - `panda_factor_server`

### 3. è°ƒè¯•é…ç½®

åˆ›å»º `launch.json`ï¼š

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Debug Factor Server",
            "type": "python",
            "request": "launch",
            "module": "panda_factor_server",
            "console": "integratedTerminal"
        },
        {
            "name": "Debug Data Hub",
            "type": "python",
            "request": "launch",
            "module": "panda_data_hub",
            "console": "integratedTerminal"
        }
    ]
}
```

## ğŸ“ˆ è¿›é˜¶ä½¿ç”¨

### 1. æ‰¹é‡å› å­åˆ†æ

```python
def batch_analyze_factors(factor_names, start_date, end_date):
    """æ‰¹é‡åˆ†æå› å­"""
    results = {}
    
    for factor_name in factor_names:
        try:
            # è·å–å› å­æ•°æ®
            factor_data = panda_data.get_factor_by_name(
                factor_name=factor_name,
                start_date=start_date,
                end_date=end_date
            )
            
            # è®¾ç½®å‚æ•°
            params = Params()
            params.start_date = start_date.replace("-", "")
            params.end_date = end_date.replace("-", "")
            params.adjustment_cycle = 5
            params.group_number = 10
            
            # è¿è¡Œåˆ†æ
            logger = get_factor_logger(factor_name)
            factor_analysis(factor_data, params, factor_name, f"batch_{factor_name}", logger)
            
            results[factor_name] = "success"
            
        except Exception as e:
            results[factor_name] = f"failed: {str(e)}"
    
    return results

# ä½¿ç”¨ç¤ºä¾‹
factor_list = ["momentum", "reversal", "volume", "volatility"]
results = batch_analyze_factors(factor_list, "2024-01-01", "2024-03-31")
print(results)
```

### 2. è‡ªå®šä¹‰æ•°æ®æº

```python
from panda_factor.data.data_provider import DataProvider

class CustomDataProvider(DataProvider):
    def get_market_data(self, start_date, end_date, **kwargs):
        """å®ç°è‡ªå®šä¹‰æ•°æ®è·å–é€»è¾‘"""
        # è¿™é‡Œå®ç°æ‚¨çš„æ•°æ®è·å–é€»è¾‘
        pass
    
    def get_factor_data(self, factor_name, start_date, end_date, **kwargs):
        """å®ç°è‡ªå®šä¹‰å› å­æ•°æ®è·å–é€»è¾‘"""
        # è¿™é‡Œå®ç°æ‚¨çš„å› å­æ•°æ®è·å–é€»è¾‘
        pass

# æ³¨å†Œè‡ªå®šä¹‰æ•°æ®æº
from panda_factor.data.data_provider import register_data_provider
register_data_provider('custom', CustomDataProvider)
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: MongoDBè¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `MongoDB connection failed`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥MongoDBæœåŠ¡çŠ¶æ€
net start MongoDB  # Windows
brew services list | grep mongodb  # macOS
sudo systemctl status mongod  # Linux

# æ£€æŸ¥é…ç½®æ–‡ä»¶
# ç¡®ä¿ config.yaml ä¸­çš„è¿æ¥ä¿¡æ¯æ­£ç¡®
```

### Q2: æ•°æ®æºè®¤è¯å¤±è´¥

**ç—‡çŠ¶**: `Authentication failed` æˆ– `Token invalid`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# Tushareç”¨æˆ·
# 1. æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®
# 2. ç¡®è®¤ç§¯åˆ†è¶³å¤Ÿ
# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥

# RiceQuantç”¨æˆ·
# 1. æ£€æŸ¥ç”¨æˆ·åå¯†ç 
# 2. ç¡®è®¤è´¦å·æƒé™
# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
```

### Q3: å› å­è®¡ç®—é”™è¯¯

**ç—‡çŠ¶**: `Factor calculation failed`

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ£€æŸ¥å› å­å…¬å¼è¯­æ³•
# ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å‡½æ•°åå’Œå‚æ•°

# å¸¸ç”¨å‡½æ•°åˆ—è¡¨ï¼š
# CLOSE, OPEN, HIGH, LOW - ä»·æ ¼æ•°æ®
# VOLUME - æˆäº¤é‡
# DELAY(x, n) - å»¶è¿ŸnæœŸ
# RANK(x) - æ’åº
# STDDEV(x, n) - æ ‡å‡†å·®
# CORR(x, y) - ç›¸å…³ç³»æ•°
```

### Q4: å†…å­˜ä¸è¶³

**ç—‡çŠ¶**: `MemoryError` æˆ–ç³»ç»Ÿå¡é¡¿

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. å‡å°‘åˆ†ææ—¶é—´èŒƒå›´
params.start_date = "2024-03-01"  # ç¼©çŸ­æ—¶é—´èŒƒå›´
params.end_date = "2024-03-31"

# 2. å‡å°‘è‚¡ç¥¨æ± 
params.stock_pool = "000300"  # ä½¿ç”¨æ²ªæ·±300æ›¿ä»£å…¨å¸‚åœº

# 3. å‡å°‘åˆ†ç»„æ•°é‡
params.group_number = 5  # å‡å°‘åˆ†ç»„
```

### Q5: åˆ†æç»“æœä¸ºç©º

**ç—‡çŠ¶**: åˆ†æå®Œæˆä½†æ²¡æœ‰ç»“æœ

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. æ£€æŸ¥æ•°æ®æ—¥æœŸèŒƒå›´
# ç¡®ä¿å› å­æ•°æ®å’Œè¡Œæƒ…æ•°æ®æœ‰é‡å 

# 2. æ£€æŸ¥è‚¡ç¥¨æ± è®¾ç½®
# ç¡®ä¿é€‰æ‹©çš„è‚¡ç¥¨æ± æœ‰è¶³å¤Ÿè‚¡ç¥¨

# 3. æ£€æŸ¥å› å­æ•°æ®è´¨é‡
# ç¡®ä¿å› å­å€¼ä¸ä¸ºç©ºæˆ–NaN
```

## ğŸ“š å­¦ä¹ èµ„æº

### 1. å®˜æ–¹æ–‡æ¡£
- [MongoDBä½¿ç”¨æ–‡æ¡£](./MongoDBä½¿ç”¨æ–‡æ¡£.md)
- [è¡Œæƒ…æ•°æ®æ›´æ–°æœºåˆ¶æ–‡æ¡£](./è¡Œæƒ…æ•°æ®æ›´æ–°æœºåˆ¶æ–‡æ¡£.md)
- [å› å­åˆ†æå¼•æ“æ–‡æ¡£](./å› å­åˆ†æå¼•æ“æ–‡æ¡£.md)

### 2. ç¤ºä¾‹ä»£ç 
- `examples/` ç›®å½•åŒ…å«å®Œæ•´ç¤ºä¾‹
- `tests/` ç›®å½•åŒ…å«æµ‹è¯•ç”¨ä¾‹

### 3. ç¤¾åŒºèµ„æº
- GitHub Issues: æŠ¥å‘Šé—®é¢˜å’Œå»ºè®®
- Wiki: è¯¦ç»†ä½¿ç”¨æ•™ç¨‹
- Discussions: ç»éªŒäº¤æµ

## ğŸ¯ ä¸‹ä¸€æ­¥

æ­å–œæ‚¨å®Œæˆäº†å¿«é€Ÿå¼€å§‹ï¼æ¥ä¸‹æ¥æ‚¨å¯ä»¥ï¼š

1. **æ·±å…¥å­¦ä¹ **: é˜…è¯»è¯¦ç»†æ–‡æ¡£äº†è§£é«˜çº§åŠŸèƒ½
2. **å®è·µé¡¹ç›®**: å°è¯•æ„å»ºè‡ªå·±çš„å› å­ç­–ç•¥
3. **è´¡çŒ®ä»£ç **: å‚ä¸å¼€æºé¡¹ç›®å¼€å‘
4. **ç¤¾åŒºäº¤æµ**: åŠ å…¥ç”¨æˆ·ç¾¤ç»„åˆ†äº«ç»éªŒ

### æ¨èå­¦ä¹ è·¯å¾„

```
æ–°æ‰‹ â†’ ç†Ÿæ‚‰Webç•Œé¢ â†’ å­¦ä¹ å› å­å…¬å¼ â†’ å°è¯•Pythonå› å­ â†’ ç†è§£åˆ†ææµç¨‹ â†’ è‡ªå®šä¹‰å¼€å‘
```

### æœ‰ç”¨çš„å‘½ä»¤é€ŸæŸ¥

```bash
# å¯åŠ¨æœåŠ¡
python -m panda_factor_server     # WebæœåŠ¡
python -m panda_data_hub          # æ•°æ®æ›´æ–°
python -m panda_llm               # LLMæœåŠ¡

# æ•°æ®æ“ä½œ
python -c "import panda_data; panda_data.init()"  # åˆå§‹åŒ–æ•°æ®
python -c "import panda_data; print(panda_data.get_all_factors())"  # æŸ¥çœ‹å› å­

# æµ‹è¯•è¿æ¥
python -c "from panda_common.handlers.database_handler import DatabaseHandler; from panda_common.config import config; DatabaseHandler(config)"  # æµ‹è¯•æ•°æ®åº“
```

---

ğŸ‰ **æ­å–œï¼æ‚¨å·²ç»æŒæ¡äº†PandaFactorçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€‚**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£æˆ–æäº¤Issueã€‚ç¥æ‚¨é‡åŒ–ç ”ç©¶é¡ºåˆ©ï¼