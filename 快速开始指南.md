# PandaFactor 快速开始指南

## 概述

PandaFactor是一个专业的量化因子计算和分析系统，本指南将帮助您在10分钟内快速搭建环境并运行第一个因子分析。

## 🚀 5分钟快速体验

### 前置要求

- Python 3.8+
- MongoDB 4.4+
- Git

### 一键启动

```bash
# 1. 克隆项目
git clone https://github.com/meaigood001/panda_factor.git
cd panda_factor

# 2. 安装依赖
pip install -r requirements.txt

# 3. 配置数据库
# 编辑 panda_common/panda_common/config.yaml
# 确保MongoDB连接信息正确

# 4. 启动服务
python -m panda_factor_server

# 5. 访问Web界面
# 浏览器打开: http://localhost:8111/factor
```

## 📋 环境准备

### 1. 系统要求

| 组件 | 最低版本 | 推荐版本 |
|------|----------|----------|
| Python | 3.8 | 3.9+ |
| MongoDB | 4.4 | 5.0+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 10GB | 50GB+ |

### 2. 安装MongoDB

#### Windows
```bash
# 下载并安装MongoDB Community Server
# https://www.mongodb.com/try/download/community

# 启动MongoDB服务
net start MongoDB
```

#### macOS
```bash
# 使用Homebrew安装
brew tap mongodb/brew
brew install mongodb-community

# 启动服务
brew services start mongodb/brew
```

#### Linux (Ubuntu)
```bash
# 导入公钥
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -

# 添加仓库
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list

# 安装
sudo apt-get update
sudo apt-get install -y mongodb-org

# 启动服务
sudo systemctl start mongod
```

### 3. 项目安装

```bash
# 克隆项目
git clone https://github.com/meaigood001/panda_factor.git
cd panda_factor

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt

# 开发模式安装各模块
cd panda_common && pip install -e ..
cd ../panda_data && pip install -e ..
cd ../panda_factor && pip install -e ..
cd ../panda_factor_server && pip install -e ..
```

## ⚙️ 配置设置

### 1. 数据库配置

编辑 `panda_common/panda_common/config.yaml`：

```yaml
# 数据库配置
MONGO_USER: "panda"
MONGO_PASSWORD: "panda"
MONGO_URI: "127.0.0.1:27017"
MONGO_AUTH_DB: "admin"
MONGO_DB: "panda"

# 数据源配置（选择一个）
DATASOURCE: tqsdk  # 或 ricequant, xtquant
DATAHUBSOURCE: "tushare"  # 或 ricequant

# Tushare配置（如果使用Tushare）
TS_TOKEN: "your_tushare_token"

# RiceQuant配置（如果使用RiceQuant）
MUSER: "your_ricequant_username"
MPASSWORD: "your_ricequant_password"
```

### 2. 数据源配置

#### Tushare（推荐新手）
1. 注册Tushare账号：https://tushare.pro/
2. 获取API Token
3. 在配置文件中设置 `TS_TOKEN`

#### RiceQuant
1. 注册RiceQuant账号：https://www.ricequant.com/
2. 获取用户名和密码
3. 在配置文件中设置 `MUSER` 和 `MPASSWORD`

### 3. 验证配置

```python
# 测试数据库连接
from panda_common.config import config
from panda_common.handlers.database_handler import DatabaseHandler

try:
    db_handler = DatabaseHandler(config)
    print("✅ 数据库连接成功")
except Exception as e:
    print(f"❌ 数据库连接失败: {e}")

# 测试数据源
import panda_data
panda_data.init()
print("✅ 数据源初始化成功")
```

## 🎯 快速体验

### 方式1：Web界面体验（推荐新手）

1. **启动Web服务**
```bash
python -m panda_factor_server
```

2. **访问界面**
- 打开浏览器访问：http://localhost:8111/factor
- 在Web界面中创建和测试因子

3. **创建第一个因子**
- 选择"新建因子"
- 输入因子名称：`my_first_factor`
- 选择因子类型：`公式模式`
- 输入因子公式：`CLOSE/DELAY(CLOSE,5)-1`
- 设置参数并运行分析

### 方式2：代码体验（适合开发者）

1. **创建简单因子**
```python
# create_simple_factor.py
from panda_factor.generate.factor_base import Factor

class SimpleFactor(Factor):
    def calculate(self, factors):
        close = factors['close']
        # 计算5日收益率因子
        result = close / self.DELAY(close, 5) - 1
        return result

# 注册因子
from panda_factor.generate.factor_loader import register_factor
register_factor('simple_return', SimpleFactor)
```

2. **运行因子分析**
```python
# run_analysis.py
import panda_data
from panda_factor.analysis.factor_analysis import factor_analysis
from panda_common.models.factor_analysis_params import Params
from panda_common.handlers.log_handler import get_factor_logger

# 初始化
panda_data.init()

# 设置参数
params = Params()
params.start_date = "2024-01-01"
params.end_date = "2024-03-31"
params.adjustment_cycle = 5
params.group_number = 10
params.factor_direction = 1

# 获取因子数据
factor_data = panda_data.get_factor_by_name(
    factor_name="simple_return",
    start_date="20240101",
    end_date="20240331"
)

# 运行分析
logger = get_factor_logger("simple_factor")
factor_analysis(factor_data, params, "simple_factor", "task_001", logger)

print("✅ 因子分析完成！")
```

## 📊 常用因子示例

### 1. 技术指标因子

```python
# 动量因子
momentum = "CLOSE/DELAY(CLOSE,20) - 1"

# 波动率因子
volatility = "STDDEV(RETURNS,20)"

# 反转因子
reversal = "-(CLOSE/DELAY(CLOSE,5) - 1)"

# 成交量因子
volume_factor = "RANK(VOLUME)"

# 价格因子
price_factor = "RANK(CLOSE)"
```

### 2. 基本面因子

```python
# 市盈率因子
pe_factor = "-1/PE"

# 市净率因子
pb_factor = "-1/PB"

# 市销率因子
ps_factor = "-1/PS"

# 换手率因子
turnover_factor = "TURNOVER"
```

### 3. Python类因子

```python
class CustomMomentumFactor(Factor):
    def calculate(self, factors):
        close = factors['close']
        volume = factors['volume']
        
        # 计算成交量加权的动量
        momentum = close / self.DELAY(close, 20) - 1
        weighted_momentum = momentum * self.RANK(volume)
        
        return self.RANK(weighted_momentum)

# 注册因子
from panda_factor.generate.factor_loader import register_factor
register_factor('volume_weighted_momentum', CustomMomentumFactor)
```

## 🔧 常用操作

### 1. 数据更新

```bash
# 启动数据更新服务
python -m panda_data_hub

# 查看更新日志
tail -f logs/data_cleaner.log
```

### 2. 因子管理

```python
# 查看所有因子
from panda_data import factor_reader
factors = factor_reader.get_all_factors()
print(f"可用因子: {factors}")

# 获取特定因子数据
factor_data = panda_data.get_factor_by_name(
    factor_name="momentum",
    start_date="20240101",
    end_date="20240331"
)
```

### 3. 分析结果查询

```python
from panda_common.handlers.database_handler import DatabaseHandler
from panda_common.config import config

db_handler = DatabaseHandler(config)

# 查询分析结果
results = db_handler.mongo_find(
    "panda",
    "factor_analysis_results",
    {"factor_name": "momentum"}
)

for result in results:
    print(f"因子: {result['factor_name']}")
    print(f"IC均值: {result['factor_data_analysis'][0]['IC_mean']}")
    print(f"年化收益: {result['group_return_analysis'][0]['年化收益率']}")
```

## 🛠️ 开发环境设置

### 1. VSCode配置

创建 `.vscode/settings.json`：

```json
{
    "python.defaultInterpreterPath": "./venv/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "python.testing.pytestEnabled": true,
    "python.testing.pytestArgs": ["tests/"]
}
```

### 2. IDE配置（PyCharm）

1. 打开项目
2. 设置Python解释器为虚拟环境
3. 将以下目录标记为Sources Root：
   - `panda_common`
   - `panda_data`
   - `panda_factor`
   - `panda_factor_server`

### 3. 调试配置

创建 `launch.json`：

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Debug Factor Server",
            "type": "python",
            "request": "launch",
            "module": "panda_factor_server",
            "console": "integratedTerminal"
        },
        {
            "name": "Debug Data Hub",
            "type": "python",
            "request": "launch",
            "module": "panda_data_hub",
            "console": "integratedTerminal"
        }
    ]
}
```

## 📈 进阶使用

### 1. 批量因子分析

```python
def batch_analyze_factors(factor_names, start_date, end_date):
    """批量分析因子"""
    results = {}
    
    for factor_name in factor_names:
        try:
            # 获取因子数据
            factor_data = panda_data.get_factor_by_name(
                factor_name=factor_name,
                start_date=start_date,
                end_date=end_date
            )
            
            # 设置参数
            params = Params()
            params.start_date = start_date.replace("-", "")
            params.end_date = end_date.replace("-", "")
            params.adjustment_cycle = 5
            params.group_number = 10
            
            # 运行分析
            logger = get_factor_logger(factor_name)
            factor_analysis(factor_data, params, factor_name, f"batch_{factor_name}", logger)
            
            results[factor_name] = "success"
            
        except Exception as e:
            results[factor_name] = f"failed: {str(e)}"
    
    return results

# 使用示例
factor_list = ["momentum", "reversal", "volume", "volatility"]
results = batch_analyze_factors(factor_list, "2024-01-01", "2024-03-31")
print(results)
```

### 2. 自定义数据源

```python
from panda_factor.data.data_provider import DataProvider

class CustomDataProvider(DataProvider):
    def get_market_data(self, start_date, end_date, **kwargs):
        """实现自定义数据获取逻辑"""
        # 这里实现您的数据获取逻辑
        pass
    
    def get_factor_data(self, factor_name, start_date, end_date, **kwargs):
        """实现自定义因子数据获取逻辑"""
        # 这里实现您的因子数据获取逻辑
        pass

# 注册自定义数据源
from panda_factor.data.data_provider import register_data_provider
register_data_provider('custom', CustomDataProvider)
```

## 🐛 常见问题

### Q1: MongoDB连接失败

**症状**: `MongoDB connection failed`

**解决方案**:
```bash
# 检查MongoDB服务状态
net start MongoDB  # Windows
brew services list | grep mongodb  # macOS
sudo systemctl status mongod  # Linux

# 检查配置文件
# 确保 config.yaml 中的连接信息正确
```

### Q2: 数据源认证失败

**症状**: `Authentication failed` 或 `Token invalid`

**解决方案**:
```bash
# Tushare用户
# 1. 检查Token是否正确
# 2. 确认积分足够
# 3. 检查网络连接

# RiceQuant用户
# 1. 检查用户名密码
# 2. 确认账号权限
# 3. 检查网络连接
```

### Q3: 因子计算错误

**症状**: `Factor calculation failed`

**解决方案**:
```python
# 检查因子公式语法
# 确保使用正确的函数名和参数

# 常用函数列表：
# CLOSE, OPEN, HIGH, LOW - 价格数据
# VOLUME - 成交量
# DELAY(x, n) - 延迟n期
# RANK(x) - 排序
# STDDEV(x, n) - 标准差
# CORR(x, y) - 相关系数
```

### Q4: 内存不足

**症状**: `MemoryError` 或系统卡顿

**解决方案**:
```python
# 1. 减少分析时间范围
params.start_date = "2024-03-01"  # 缩短时间范围
params.end_date = "2024-03-31"

# 2. 减少股票池
params.stock_pool = "000300"  # 使用沪深300替代全市场

# 3. 减少分组数量
params.group_number = 5  # 减少分组
```

### Q5: 分析结果为空

**症状**: 分析完成但没有结果

**解决方案**:
```python
# 1. 检查数据日期范围
# 确保因子数据和行情数据有重叠

# 2. 检查股票池设置
# 确保选择的股票池有足够股票

# 3. 检查因子数据质量
# 确保因子值不为空或NaN
```

## 📚 学习资源

### 1. 官方文档
- [MongoDB使用文档](./MongoDB使用文档.md)
- [行情数据更新机制文档](./行情数据更新机制文档.md)
- [因子分析引擎文档](./因子分析引擎文档.md)

### 2. 示例代码
- `examples/` 目录包含完整示例
- `tests/` 目录包含测试用例

### 3. 社区资源
- GitHub Issues: 报告问题和建议
- Wiki: 详细使用教程
- Discussions: 经验交流

## 🎯 下一步

恭喜您完成了快速开始！接下来您可以：

1. **深入学习**: 阅读详细文档了解高级功能
2. **实践项目**: 尝试构建自己的因子策略
3. **贡献代码**: 参与开源项目开发
4. **社区交流**: 加入用户群组分享经验

### 推荐学习路径

```
新手 → 熟悉Web界面 → 学习因子公式 → 尝试Python因子 → 理解分析流程 → 自定义开发
```

### 有用的命令速查

```bash
# 启动服务
python -m panda_factor_server     # Web服务
python -m panda_data_hub          # 数据更新
python -m panda_llm               # LLM服务

# 数据操作
python -c "import panda_data; panda_data.init()"  # 初始化数据
python -c "import panda_data; print(panda_data.get_all_factors())"  # 查看因子

# 测试连接
python -c "from panda_common.handlers.database_handler import DatabaseHandler; from panda_common.config import config; DatabaseHandler(config)"  # 测试数据库
```

---

🎉 **恭喜！您已经掌握了PandaFactor的基本使用方法。**

如有问题，请查看文档或提交Issue。祝您量化研究顺利！