# PandaFactor è¡Œæƒ…æ•°æ®æ›´æ–°æœºåˆ¶æ–‡æ¡£

## æ¦‚è¿°

PandaFactoré¡¹ç›®å®ç°äº†è‡ªåŠ¨åŒ–çš„è¡Œæƒ…æ•°æ®æ›´æ–°æœºåˆ¶ï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡ä»å¤šä¸ªæ•°æ®æºè·å–è‚¡ç¥¨è¡Œæƒ…æ•°æ®ï¼Œç»è¿‡æ¸…æ´—å¤„ç†åå­˜å‚¨åˆ°MongoDBæ•°æ®åº“ä¸­ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†è¡Œæƒ…æ•°æ®æ›´æ–°çš„å®Œæ•´æµç¨‹å’Œå®ç°æœºåˆ¶ã€‚

## 1. ç³»ç»Ÿæ¶æ„

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®æº        â”‚    â”‚   æ•°æ®æ¸…æ´—å™¨     â”‚    â”‚   MongoDB       â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Tushare    â”‚ â”‚    â”‚ â”‚  TS Cleaner  â”‚ â”‚    â”‚ â”‚stock_market â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ RiceQuant   â”‚ â”‚    â”‚ â”‚  RQ Cleaner  â”‚ â”‚    â”‚ â”‚   stocks    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  XTQuant    â”‚ â”‚    â”‚ â”‚  XT Cleaner  â”‚ â”‚    â”‚ â”‚factor_base  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ä»»åŠ¡è°ƒåº¦å™¨      â”‚
                    â”‚                  â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚DataScheduler â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚                  â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚FactorSchedulerâ”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|------|---------|
| `SchedulerManager` | è°ƒåº¦å™¨ç®¡ç†å™¨ | `panda_data_hub/_main_auto_.py` |
| `DataScheduler` | æ•°æ®æ›´æ–°è°ƒåº¦å™¨ | `panda_data_hub/task/data_scheduler.py` |
| `FactorCleanerScheduler` | å› å­æ¸…æ´—è°ƒåº¦å™¨ | `panda_data_hub/task/factor_clean_scheduler.py` |
| `TSStockMarketCleaner` | Tushareè¡Œæƒ…æ¸…æ´—å™¨ | `panda_data_hub/data/tushare_stock_market_cleaner.py` |
| `RQStockMarketCleaner` | RiceQuantè¡Œæƒ…æ¸…æ´—å™¨ | `panda_data_hub/data/ricequant_stock_market_cleaner.py` |
| `XTStockMarketCleaner` | XTQuantè¡Œæƒ…æ¸…æ´—å™¨ | `panda_data_hub/data/xtquant_stock_market_cleaner.py` |

## 2. è°ƒåº¦æœºåˆ¶

### 2.1 å¯åŠ¨æµç¨‹

```python
# ä¸»å¯åŠ¨æ–‡ä»¶
if __name__ == "__main__":
    # æ³¨å†Œä¿¡å·å¤„ç†å™¨
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        # åˆ›å»ºå¹¶å¯åŠ¨æ•°æ®è°ƒåº¦å™¨
        manager.data_scheduler = DataScheduler()
        manager.data_scheduler.schedule_data()
        
        # åˆ›å»ºå¹¶å¯åŠ¨å› å­è°ƒåº¦å™¨
        manager.factor_scheduler = FactorCleanerScheduler()
        manager.factor_scheduler.schedule_data()
        
        # ä¿æŒè¿è¡Œ
        while True:
            time.sleep(1)
    except Exception as e:
        logger.error(f"Error starting scheduler: {str(e)}")
```

### 2.2 å®šæ—¶ä»»åŠ¡é…ç½®

```yaml
# é…ç½®æ–‡ä»¶ (config.yaml)
# è‚¡ç¥¨æ•°æ®æ›´æ–°æ—¶é—´(æ¯æ—¥)
STOCKS_UPDATE_TIME: "20:00"
# å› å­æ•°æ®æ›´æ–°æ—¶é—´(æ¯æ—¥)
FACTOR_UPDATE_TIME: "20:30"
```

### 2.3 Cronè§¦å‘å™¨

```python
def schedule_data(self):
    time = self.config["STOCKS_UPDATE_TIME"]
    hour, minute = time.split(":")
    trigger = CronTrigger(
        minute=minute,
        hour=hour,
        day='*',
        month='*',
        day_of_week='*'
    )
    
    # æ·»åŠ å®šæ—¶ä»»åŠ¡
    self.scheduler.add_job(
        self._process_data,
        trigger=trigger,
        id=f"data_{datetime.datetime.now().strftime('%Y%m%d')}",
        replace_existing=True
    )
```

## 3. æ•°æ®æºæ”¯æŒ

### 3.1 æ”¯æŒçš„æ•°æ®æº

| æ•°æ®æº | é…ç½®æ ‡è¯† | è®¤è¯æ–¹å¼ | çŠ¶æ€ |
|--------|----------|----------|------|
| Tushare | `tushare` | Token | âœ… æ´»è·ƒ |
| RiceQuant | `ricequant` | ç”¨æˆ·å/å¯†ç  | âœ… æ´»è·ƒ |
| XTQuant | `xuntou` | Token | ğŸ”„ å¼€å‘ä¸­ |

### 3.2 æ•°æ®æºé…ç½®

```yaml
# æ•°æ®æºé€‰æ‹©
DATASOURCE: tqsdk
DATAHUBSOURCE: ""

# Tushareé…ç½®
TS_TOKEN: "your_tushare_token"

# RiceQuanté…ç½®
MUSER: "your_username"
MPASSWORD: "your_password"

# XTQuanté…ç½®
XT_TOKEN: "your_xt_token"
```

## 4. æ•°æ®æ¸…æ´—æµç¨‹

### 4.1 äº¤æ˜“æ—¥åˆ¤æ–­

æ‰€æœ‰æ•°æ®æ¸…æ´—å™¨é¦–å…ˆåˆ¤æ–­å½“å‰æ—¥æœŸæ˜¯å¦ä¸ºäº¤æ˜“æ—¥ï¼š

```python
def is_trading_day(self, date):
    """åˆ¤æ–­ä¼ å…¥çš„æ—¥æœŸæ˜¯å¦ä¸ºè‚¡ç¥¨äº¤æ˜“æ—¥"""
    try:
        # Tushareæ–¹å¼
        cal_df = self.pro.query('trade_cal',
                                exchange='SSE',
                                start_date=date.replace('-', ''),
                                end_date=date.replace('-', ''))
        return not cal_df.empty and cal_df.iloc[0]['is_open'] == 1
        
        # RiceQuantæ–¹å¼
        trading_days = rqdatac.get_trading_dates(
            start_date=date,
            end_date=date
        )
        return len(trading_days) > 0
    except Exception as e:
        logger.error(f"æ£€æŸ¥äº¤æ˜“æ—¥å¤±è´¥ {date}: {str(e)}")
        return False
```

### 4.2 æ•°æ®è·å–æµç¨‹

#### 4.2.1 Tushareæ•°æ®è·å–

```python
def clean_meta_market_data(self, date_str):
    try:
        # è·å–å½“æ—¥è‚¡ç¥¨å†å²è¡Œæƒ…
        price_data = self.pro.query('daily', trade_date=date)
        
        # è·å–æŒ‡æ•°æˆåˆ†è‚¡
        hs_300 = self.pro.query('index_weight', index_code='399300.SZ', 
                               start_date=mid_date, end_date=last_date)
        zz_500 = self.pro.query('index_weight', index_code='000905.SH', 
                               start_date=mid_date, end_date=last_date)
        zz_1000 = self.pro.query('index_weight', index_code='000852.SH', 
                                start_date=mid_date, end_date=last_date)
        
        # æ•°æ®æ¸…æ´—å’Œè½¬æ¢
        price_data = self.clean_and_transform_data(price_data, hs_300, zz_500, zz_1000)
        
        # æ‰¹é‡å†™å…¥æ•°æ®åº“
        self.batch_upsert_to_mongodb(price_data)
    except Exception as e:
        logger.error(f"æ•°æ®æ¸…æ´—å¤±è´¥: {str(e)}")
```

#### 4.2.2 RiceQuantæ•°æ®è·å–

```python
def clean_meta_market_data(self, date_str):
    try:
        # è·å–æ‰€æœ‰è‚¡ç¥¨ä»£ç 
        symbol_list = rqdatac.all_instruments(type='CS', market='cn', date=None)
        
        # è·å–å†å²è¡Œæƒ…æ•°æ®
        price_data = rqdatac.get_price(
            order_book_ids=symbol_list['order_book_id'].tolist(),
            start_date=date_str,
            end_date=date_str,
            adjust_type='none'
        )
        
        # è·å–æŒ‡æ•°æˆåˆ†è‚¡
        self.get_index_components(start_date=date_str, end_date=date_str)
        
        # æ•°æ®æ¸…æ´—å’Œè½¬æ¢
        merged_data = self.clean_and_transform_data(price_data, symbol_list)
        
        # æ‰¹é‡å†™å…¥æ•°æ®åº“
        self.batch_upsert_to_mongodb(merged_data)
    except Exception as e:
        logger.error(f"æ•°æ®æ¸…æ´—å¤±è´¥: {str(e)}")
```

### 4.3 æ•°æ®æ¸…æ´—å’Œè½¬æ¢

#### 4.3.1 å­—æ®µæ˜ å°„

| åŸå§‹å­—æ®µ | ç›®æ ‡å­—æ®µ | è½¬æ¢è§„åˆ™ |
|---------|---------|---------|
| `trade_date` | `date` | æ ¼å¼åŒ–ä¸ºYYYYMMDD |
| `ts_code`/`order_book_id` | `symbol` | æ·»åŠ äº¤æ˜“æ‰€åç¼€ |
| `vol` | `volume` | ä¹˜ä»¥100ï¼ˆæ‰‹è½¬æ¢ä¸ºè‚¡ï¼‰ |
| `prev_close` | `pre_close` | å­—æ®µé‡å‘½å |
| `symbol` | `name` | å­—æ®µé‡å‘½å |

#### 4.3.2 æŒ‡æ•°æˆåˆ†è‚¡æ ‡è®°

```python
def clean_index_components(self, date, data_symbol, hs_300, zz_500, zz_1000):
    """æ ‡è®°æŒ‡æ•°æˆåˆ†è‚¡"""
    try:
        if data_symbol in hs_300['con_code'].values:
            return '100'  # æ²ªæ·±300
        elif data_symbol in zz_500['con_code'].values:
            return '010'  # ä¸­è¯500
        elif data_symbol in zz_1000['con_code'].values:
            return '001'  # ä¸­è¯1000
        else:
            return '000'  # éæˆåˆ†è‚¡
    except Exception as e:
        logger.error(f"æŒ‡æ•°æˆåˆ†è‚¡æ ‡è®°å¤±è´¥: {str(e)}")
        return None
```

#### 4.3.3 æ¶¨è·Œåœä»·æ ¼è®¡ç®—

```python
def calculate_upper_limit(stock_code, prev_close, stock_name):
    """è®¡ç®—æ¶¨åœä»·æ ¼"""
    if 'ST' in stock_name or '*ST' in stock_name:
        return round(prev_close * 1.05, 2)  # STè‚¡ç¥¨æ¶¨è·Œå¹…é™åˆ¶5%
    else:
        return round(prev_close * 1.10, 2)  # æ™®é€šè‚¡ç¥¨æ¶¨è·Œå¹…é™åˆ¶10%

def calculate_lower_limit(stock_code, prev_close, stock_name):
    """è®¡ç®—è·Œåœä»·æ ¼"""
    if 'ST' in stock_name or '*ST' in stock_name:
        return round(prev_close * 0.95, 2)  # STè‚¡ç¥¨è·Œè·Œå¹…é™åˆ¶5%
    else:
        return round(prev_close * 0.90, 2)  # æ™®é€šè‚¡ç¥¨è·Œè·Œå¹…é™åˆ¶10%
```

### 4.4 æ•°æ®å­˜å‚¨

#### 4.4.1 æ‰¹é‡æ›´æ–°æ“ä½œ

```python
def batch_upsert_to_mongodb(self, price_data):
    """æ‰¹é‡æ›´æ–°åˆ°MongoDB"""
    ensure_collection_and_indexes("stock_market")
    
    upsert_operations = []
    for record in price_data.to_dict('records'):
        upsert_operations.append(UpdateOne(
            {'date': record['date'], 'symbol': record['symbol']},
            {'$set': record},
            upsert=True
        ))
    
    if upsert_operations:
        self.db_handler.mongo_client[self.config["MONGO_DB"]]['stock_market'].bulk_write(
            upsert_operations)
        logger.info(f"æˆåŠŸæ›´æ–°å¸‚åœºæ•°æ®: {len(upsert_operations)} æ¡è®°å½•")
```

#### 4.4.2 æ•°æ®åº“é›†åˆç»“æ„

```javascript
// stock_marketé›†åˆç»“æ„
{
  "_id": ObjectId,
  "date": "20240320",        // äº¤æ˜“æ—¥æœŸ
  "symbol": "000001.SZ",     // è‚¡ç¥¨ä»£ç 
  "open": 10.50,             // å¼€ç›˜ä»·
  "high": 10.80,             // æœ€é«˜ä»·
  "low": 10.40,              // æœ€ä½ä»·
  "close": 10.75,            // æ”¶ç›˜ä»·
  "volume": 1000000,         // æˆäº¤é‡ï¼ˆè‚¡ï¼‰
  "pre_close": 10.45,        // å‰æ”¶ç›˜ä»·
  "limit_up": 11.50,         // æ¶¨åœä»·
  "limit_down": 9.40,        // è·Œåœä»·
  "index_component": "100",  // æŒ‡æ•°æˆåˆ†è‚¡æ ‡è®°
  "name": "å¹³å®‰é“¶è¡Œ"          // è‚¡ç¥¨åç§°
}
```

## 5. è‚¡ç¥¨åŸºç¡€ä¿¡æ¯æ›´æ–°

### 5.1 è‚¡ç¥¨å…ƒæ•°æ®æ¸…æ´—

```python
def clean_metadata(self):
    """æ¸…æ´—è‚¡ç¥¨åŸºç¡€ä¿¡æ¯"""
    try:
        # è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
        stocks = self.pro.query('stock_basic')
        stocks = stocks[['ts_code', 'name']]
        stocks = stocks[stocks["name"] != "UNKNOWN"]
        
        # å­—æ®µè½¬æ¢
        stocks['symbol'] = stocks['ts_code'].apply(get_exchange_suffix)
        stocks = stocks.drop(columns=['ts_code'])
        stocks['expired'] = False
        
        # æ¸…ç©ºå¹¶é‡æ–°æ’å…¥
        self.db_handler.mongo_delete(self.config["MONGO_DB"], 'stocks', {})
        self.db_handler.mongo_insert_many(
            self.config["MONGO_DB"],
            'stocks',
            stocks.to_dict('records')
        )
    except Exception as e:
        logger.error(f"è‚¡ç¥¨å…ƒæ•°æ®æ¸…æ´—å¤±è´¥: {str(e)}")
```

### 5.2 stocksé›†åˆç»“æ„

```javascript
// stocksé›†åˆç»“æ„
{
  "_id": ObjectId,
  "symbol": "000001.SZ",     // è‚¡ç¥¨ä»£ç 
  "name": "å¹³å®‰é“¶è¡Œ",         // è‚¡ç¥¨åç§°
  "expired": false           // æ˜¯å¦é€€å¸‚
}
```

## 6. é”™è¯¯å¤„ç†å’Œç›‘æ§

### 6.1 å¼‚å¸¸å¤„ç†æœºåˆ¶

```python
def _process_data(self):
    """å¤„ç†æ•°æ®æ¸…æ´—å’Œå…¥åº“"""
    logger.info(f"å¼€å§‹å¤„ç†æ•°æ®æ›´æ–°")
    try:
        data_source = config['DATAHUBSOURCE']
        if data_source == 'ricequant':
            # RiceQuantæ•°æ®å¤„ç†
            stocks_cleaner = RQStockCleaner(self.config)
            stocks_cleaner.clean_metadata()
            stock_market_cleaner = RQStockMarketCleaner(self.config)
            stock_market_cleaner.stock_market_clean_daily()
        elif data_source == 'tushare':
            # Tushareæ•°æ®å¤„ç†
            stocks_cleaner = TSStockCleaner(self.config)
            stocks_cleaner.clean_metadata()
            stock_market_cleaner = TSStockMarketCleaner(self.config)
            stock_market_cleaner.stock_market_clean_daily()
    except Exception as e:
        logger.error(f"æ•°æ®å¤„ç†é”™è¯¯: {str(e)}")
```

### 6.2 æ—¥å¿—è®°å½•

```python
# æ—¥å¿—é…ç½®ç¤ºä¾‹
logger.info("å¼€å§‹å¸‚åœºæ•°æ®æ¸…æ´—")
logger.info(f"æˆåŠŸæ›´æ–°å¸‚åœºæ•°æ®: {len(upsert_operations)} æ¡è®°å½•")
logger.error(f"æ•°æ®æ¸…æ´—å¤±è´¥: {str(e)}")
logger.warning(f"è·³è¿‡éäº¤æ˜“æ—¥: {date_str}")
```

### 6.3 æ€§èƒ½ç›‘æ§

```python
# æŸ¥è¯¢æ€§èƒ½ç›‘æ§
start_time = time.time()
records = db_handler.mongo_find(db_name, collection_name, query)
logger.info(f"æŸ¥è¯¢è€—æ—¶: {time.time() - start_time:.3f} ç§’")
```

## 7. éƒ¨ç½²å’Œè¿ç»´

### 7.1 æœåŠ¡å¯åŠ¨

```bash
# å¯åŠ¨æ•°æ®æ›´æ–°æœåŠ¡
python -m panda_data_hub

# æˆ–è€…ä½¿ç”¨ä¸»ç¨‹åº
python panda_data_hub/_main_auto_.py
```

### 7.2 æœåŠ¡ç®¡ç†

```python
# ä¿¡å·å¤„ç†
def signal_handler(signum, frame):
    logger.info("æ”¶åˆ°å…³é—­ä¿¡å·ï¼Œåœæ­¢è°ƒåº¦å™¨...")
    manager.stop()
    sys.exit(0)

# ä¼˜é›…åœæ­¢
def stop(self):
    """åœæ­¢è°ƒåº¦å™¨"""
    self.scheduler.shutdown()
```

### 7.3 é…ç½®çƒ­æ›´æ–°

```python
def reload_schedule(self):
    """é‡æ–°åŠ è½½å®šæ—¶ä»»åŠ¡"""
    self.scheduler.remove_all_jobs()
    self.schedule_data()
    logger.info("å®šæ—¶ä»»åŠ¡é‡æ–°åŠ è½½å®Œæˆ")
```

## 8. æœ€ä½³å®è·µ

### 8.1 æ•°æ®è´¨é‡ä¿è¯

1. **äº¤æ˜“æ—¥éªŒè¯**: åªæœ‰äº¤æ˜“æ—¥æ‰æ‰§è¡Œæ•°æ®æ›´æ–°
2. **æ•°æ®å»é‡**: ä½¿ç”¨upsertæ“ä½œé¿å…é‡å¤æ•°æ®
3. **å­—æ®µéªŒè¯**: æ£€æŸ¥å…³é”®å­—æ®µçš„æœ‰æ•ˆæ€§
4. **å¼‚å¸¸è¿‡æ»¤**: è¿‡æ»¤æ‰æ— æ•ˆçš„è‚¡ç¥¨æ•°æ®

### 8.2 æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨bulk_writeæå‡å†™å…¥æ€§èƒ½
2. **ç´¢å¼•ä¼˜åŒ–**: åœ¨dateå’Œsymbolå­—æ®µä¸Šå»ºç«‹å¤åˆç´¢å¼•
3. **è¿æ¥å¤ç”¨**: ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†æ•°æ®åº“è¿æ¥
4. **åˆ†æ‰¹å¤„ç†**: å¤§æ•°æ®é‡åˆ†æ‰¹å¤„ç†é¿å…å†…å­˜æº¢å‡º

### 8.3 ç›‘æ§å‘Šè­¦

1. **æ—¥å¿—ç›‘æ§**: ç›‘æ§é”™è¯¯æ—¥å¿—å’Œæ€§èƒ½æ—¥å¿—
2. **æ•°æ®å®Œæ•´æ€§**: å®šæœŸæ£€æŸ¥æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
3. **æœåŠ¡å¯ç”¨æ€§**: ç›‘æ§è°ƒåº¦æœåŠ¡çš„è¿è¡ŒçŠ¶æ€
4. **æ•°æ®æºçŠ¶æ€**: ç›‘æ§å„æ•°æ®æºçš„å¯ç”¨æ€§

## 9. æ•…éšœæ’é™¤

### 9.1 å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| æ•°æ®æ›´æ–°å¤±è´¥ | ç½‘ç»œè¿æ¥é—®é¢˜ | æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæ•°æ®æºçŠ¶æ€ |
| æ•°æ®é‡å¤ | upsertæ¡ä»¶é”™è¯¯ | æ£€æŸ¥å¤åˆé”®çš„å”¯ä¸€æ€§ |
| æ€§èƒ½ç¼“æ…¢ | ç´¢å¼•ç¼ºå¤± | æ£€æŸ¥æ•°æ®åº“ç´¢å¼• |
| å†…å­˜æº¢å‡º | æ•°æ®é‡è¿‡å¤§ | åˆ†æ‰¹å¤„ç†æ•°æ® |

### 9.2 è°ƒè¯•å·¥å…·

```python
# æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
scheduler.get_jobs()

# æŸ¥çœ‹æ‰§è¡Œå†å²
scheduler.print_jobs()

# æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡
scheduler.modify_job(job_id, next_run_time=datetime.now())
```

## 10. æ‰©å±•å¼€å‘

### 10.1 æ–°å¢æ•°æ®æº

1. å®ç°æ•°æ®æ¸…æ´—å™¨åŸºç±»
2. æ·»åŠ æ•°æ®æºé…ç½®
3. åœ¨è°ƒåº¦å™¨ä¸­æ·»åŠ æ•°æ®æºåˆ†æ”¯
4. æµ‹è¯•æ•°æ®è·å–å’Œæ¸…æ´—åŠŸèƒ½

### 10.2 æ–°å¢æ•°æ®å­—æ®µ

1. ä¿®æ”¹æ•°æ®æ¸…æ´—é€»è¾‘
2. æ›´æ–°æ•°æ®åº“é›†åˆç»“æ„
3. è°ƒæ•´ç´¢å¼•è®¾è®¡
4. æ›´æ–°ç›¸å…³æŸ¥è¯¢é€»è¾‘

## 11. ä»0å¼€å§‹æ•°æ®æ›´æ–°è„šæœ¬

### 11.1 æ ¸å¿ƒè„šæœ¬åŠŸèƒ½

PandaFactoré¡¹ç›®**ç¡®å®å¸¦æœ‰ä»0å¼€å§‹æ›´æ–°æ•°æ®çš„å®Œæ•´è„šæœ¬**ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

#### 11.1.1 å†å²æ•°æ®å›å¡«API
- **è‚¡ç¥¨è¡Œæƒ…æ•°æ®æ›´æ–°**:
  - **APIè·¯å¾„**: `/datahub/api/v1/upsert_stockmarket_final`
  - **å‚æ•°**: `start_date`, `end_date`
  - **åŠŸèƒ½**: æ”¯æŒæŒ‡å®šæ—¥æœŸèŒƒå›´çš„å…¨é‡å†å²æ•°æ®æ›´æ–°

- **å› å­æ•°æ®æ›´æ–°**:
  - **APIè·¯å¾„**: `/datahub/api/v1/upsert_factor_final`
  - **å‚æ•°**: `start_date`, `end_date`
  - **åŠŸèƒ½**: æ”¯æŒæŒ‡å®šæ—¥æœŸèŒƒå›´çš„å› å­æ•°æ®å…¨é‡æ›´æ–°

#### 11.1.2 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- **ç´¢å¼•åˆ›å»ºè„šæœ¬**: `panda_data/scripts/create_indexes.py`
  - ä¸ºMongoDBåˆ›å»ºå¿…è¦çš„æ•°æ®åº“ç´¢å¼•
  - å¯åŠ¨æ–¹å¼: `python panda_data/panda_data/scripts/create_indexes.py`

- **æ•°æ®åº“ä¼˜åŒ–è„šæœ¬**: `panda_data/scripts/optimize_mongodb.py`
  - ä¼˜åŒ–MongoDBæ€§èƒ½ï¼Œæ”¯æŒåˆ†åŒºå’Œç´¢å¼•é‡å»º
  - å¯åŠ¨æ–¹å¼: `python panda_data/panda_data/scripts/optimize_mongodb.py --rebuild-indexes --create-partitions`

#### 11.1.3 è‡ªåŠ¨è°ƒåº¦æœåŠ¡
- **ä¸»è°ƒåº¦å™¨**: `panda_data_hub/_main_auto_.py`
  - æ¯æ—¥å®šæ—¶æ›´æ–°æ•°æ®ï¼ˆé»˜è®¤20:00æ‰§è¡Œï¼‰
  - å¯åŠ¨æ–¹å¼: `python -m panda_data_hub`

### 11.2 ä»0å¼€å§‹æ•°æ®æ›´æ–°çš„å®Œæ•´æµç¨‹

#### æ–¹å¼1ï¼šä½¿ç”¨Web APIï¼ˆæ¨èï¼‰
```bash
# 1. å¯åŠ¨æœåŠ¡å™¨
python -m panda_factor_server  # å¯åŠ¨åœ¨8111ç«¯å£

# 2. è°ƒç”¨APIå…¨é‡æ›´æ–°å†å²æ•°æ®ï¼ˆä¾‹å¦‚2020-2024å¹´ï¼‰
curl "http://localhost:8111/datahub/api/v1/upsert_stockmarket_final?start_date=20200101&end_date=20241231"

# 3. æ›´æ–°å› å­æ•°æ®
curl "http://localhost:8111/datahub/api/v1/upsert_factor_final?start_date=20200101&end_date=20241231"

# 4. æŸ¥çœ‹æ›´æ–°è¿›åº¦
curl "http://localhost:8111/datahub/api/v1/get_progress_stock_final"
curl "http://localhost:8111/datahub/api/v1/get_progress_factor_final"
```

#### æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨æœåŠ¡ç±»
```python
from panda_data_hub.services.ts_stock_market_clean_service import StockMarketCleanTSServicePRO
from panda_common.config import config

# åˆå§‹åŒ–æœåŠ¡
service = StockMarketCleanTSServicePRO(config)

# æ‰§è¡Œå†å²æ•°æ®æ¸…æ´—
service.stock_market_history_clean("20200101", "20241231")
```

### 11.3 æ•°æ®åˆå§‹åŒ–æ­¥éª¤

1. **ç¯å¢ƒå‡†å¤‡**:
   - å®‰è£…MongoDBå¹¶å¯åŠ¨æœåŠ¡
   - é…ç½® `panda_common/panda_common/config.yaml`
   - è®¾ç½®æ•°æ®æºTokenï¼ˆTushare/RiceQuantï¼‰

2. **åˆ›å»ºæ•°æ®åº“ç´¢å¼•**:
```bash
python panda_data/panda_data/scripts/create_indexes.py
```

3. **å…¨é‡æ•°æ®æ›´æ–°**:
```bash
# å¯åŠ¨æœåŠ¡å™¨
python -m panda_factor_server

# é€šè¿‡APIæˆ–ç›´æ¥è°ƒç”¨æœåŠ¡æ›´æ–°æ•°æ®
```

4. **éªŒè¯æ•°æ®**:
```python
import panda_data
panda_data.init()

# æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
market_data = panda_data.get_market_data("20240101", "20240110")
print(f"è·å–åˆ° {len(market_data)} æ¡è¡Œæƒ…æ•°æ®")
```

### 11.4 æ³¨æ„äº‹é¡¹

1. **æ•°æ®æºé™åˆ¶**: Tushareæœ‰APIè°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œå¤§é‡å†å²æ•°æ®æ›´æ–°éœ€è¦è¾ƒé•¿æ—¶é—´
2. **å­˜å‚¨ç©ºé—´**: å…¨é‡å†å²æ•°æ®éœ€è¦è¾ƒå¤§å­˜å‚¨ç©ºé—´ï¼ˆå»ºè®®50GB+ï¼‰
3. **ç½‘ç»œç¨³å®š**: é•¿æ—¶é—´æ•°æ®æ›´æ–°éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥
4. **è¿›åº¦ç›‘æ§**: ä½¿ç”¨APIçš„è¿›åº¦æŸ¥è¯¢åŠŸèƒ½ç›‘æ§æ›´æ–°çŠ¶æ€

## æ€»ç»“

PandaFactorçš„è¡Œæƒ…æ•°æ®æ›´æ–°æœºåˆ¶é€šè¿‡è‡ªåŠ¨åŒ–è°ƒåº¦ã€å¤šæ•°æ®æºæ”¯æŒã€æ•°æ®æ¸…æ´—å’Œè´¨é‡ä¿è¯ï¼Œå®ç°äº†å¯é çš„è¡Œæƒ…æ•°æ®æ›´æ–°ã€‚ç³»ç»Ÿå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³é‡åŒ–æŠ•èµ„å¯¹æ•°æ®è´¨é‡å’Œå®æ—¶æ€§çš„è¦æ±‚ã€‚

**ç‰¹åˆ«è¯´æ˜**: PandaFactoré¡¹ç›®**æä¾›äº†å®Œæ•´çš„ä»0å¼€å§‹æ•°æ®æ›´æ–°è§£å†³æ–¹æ¡ˆ**ï¼ŒåŒ…æ‹¬å†å²æ•°æ®å›å¡«ã€æ•°æ®åº“åˆå§‹åŒ–ã€å¤šæ•°æ®æºæ”¯æŒå’Œè¿›åº¦ç›‘æ§ç­‰åŠŸèƒ½ï¼Œå¯ä»¥æ»¡è¶³ä»é›¶å¼€å§‹æ„å»ºå®Œæ•´å†å²æ•°æ®åº“çš„éœ€æ±‚ã€‚